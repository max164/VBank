* 2026.02.03 19:54:26

# Анализ предметной области системы виртуального банка VBank

---

## 1. Назначение и границы предметной области

VBank — виртуальная банковская система, предназначенная для:
- ведения счетов пользователей в нескольких валютах;
- выполнения внутренних финансовых операций между счетами;
- обработки заявок, требующих одобрения оператора;
- обеспечения аудита и воспроизводимости финансового состояния.

Система не является платёжной системой, не взаимодействует с внешними банками и не выполняет реальных финансовых расчётов. Все операции существуют исключительно внутри домена VBank.

---

## 2. Ключевые принципы предметной области

1. Баланс счёта (Balance) хранится явно и используется как рабочее значение.
2. Журнал проводок (Ledger) является вторичным источником истины и используется для:
    - аудита;
    - сверки;
    - восстановления состояния при ошибках.
3. Любая финансовая операция необратима:
    - отмена (CANCELLED) запрещена;
    - компенсация выполняется только новой финансовой операцией.
4. Все финансовые операции атомарны и транзакционны.
5. Отрицательный баланс разрешён только для счетов, у которых это явно разрешено типом счёта (например, кредитный счёт).
6. Конкурентный доступ регулируется транзакционной блокировкой БД.
7. Деньги существуют только в рамках конкретного счёта и валюты.

---

## 3. Термины и определения

- Пользователь (User) — субъект системы, владеющий счетами и инициирующий операции.
- Счёт (Account) — объект учёта денежных средств пользователя в одной валюте.
- Тип счёта (Account Type) — классификация счёта, определяющая его поведение (например, разрешён ли отрицательный баланс).
- Финансовая операция (Transaction) — бизнес-факт изменения денежных средств.
- Проводка (Ledger Entry) — учётная запись фактического изменения баланса счёта.
- Заявка (Request) — запрос на действие, требующее одобрения оператора.
- Валюта (Currency) — справочная сущность денежной единицы.
- Аудит (Audit Log) — неизменяемый журнал действий субъектов системы.
- Оператор (Operator) — пользователь с полномочиями одобрения заявок.
- Администратор (Admin) — пользователь с полномочиями управления системой.
- Настройки системы (System Settings) — централизованный справочник режимов работы VBank.

---

## 4. Участники предметной области (роли)

### 4.1. Пользователь (Client)

Лицо, владеющее счетами и инициирующее операции и заявки.

### 4.2. Оператор (Operator)

Сотрудник системы, обрабатывающий заявки:
- на регистрацию пользователей;
- на пополнение и снятие средств;
- на переводы между счетами.

Имеет доступ к персональным данным пользователей и полной истории операций.

### 4.3. Администратор (Admin)

Системная роль для:
- управления пользователями и ролями;
- управления справочниками;
- управления настройками системы;
- просмотра аудита.

---

## 5. Ключевые объекты предметной области

### 5.1. Пользователь (User)

Тип: объектный

Назначение: субъект владения счетами и инициатор операций.

Атрибуты:
- Идентификатор пользователя (User ID) — UUID, уникальный идентификатор
- Email (Email) — строка, уникальный
- Логин (Username) — строка, уникальный
- Номер телефона (Phone Number) — строка, уникальная
- Роль (Role) — перечисление: Client / Operator / Admin
- Статус (Status) — перечисление: Active / Blocked
- Дата регистрации (Registration Date) — дата и время

---

### 5.2. Счёт (Account)

Тип: объектный

Назначение: хранение денежных средств пользователя в одной валюте.

Инварианты:
- Один пользователь может иметь не более одного счёта одного типа в одной валюте.
- Отрицательный баланс возможен только если это разрешено типом счёта.

Атрибуты:
- Идентификатор счёта (Account ID) — UUID
- Номер счёта (Account Number) — строка из 20 цифр
- Пользователь (User) — ссылка на владельца
- Валюта (Currency) — ссылка на валюту
- Тип счёта (Account Type) — ссылка на справочник типов счетов
- Баланс (Balance) — decimal / numeric
- Статус (Status) — Active / Closed / Blocked

---

### 5.3. Тип счёта (Account Type)

Тип: справочный

Назначение: определяет поведение счёта.

Атрибуты:
- Код типа счёта (Account Type Code) — строка, уникальный код типа счёта
- Код типа продукта (Product Type Code) — строка из 3 цифр, используется в Account Number (позиции 7–9)
- Наименование (Name) — строка
- Разрешён отрицательный баланс (Allow Negative Balance) — boolean

---

### 5.4. Валюта (Currency)

Тип: справочный

Назначение: описание денежной единицы.

Атрибуты:
- Идентификатор валюты (Currency ID) — UUID
- Код валюты (Currency Code) — строка (RUB, USD, EUR)
- Наименование (Name) — строка
- Точность (Precision) — целое число (2–10)
- Статус (Status) — Active / Disabled

---

### 5.5. Финансовая операция (Transaction)

Тип: объектный, ключевой

Назначение: фиксирует бизнес-факт изменения денежных средств.

Принципы:
- Может быть отклонена без изменения баланса.
- При необходимости отмены создаётся компенсирующая операция.

Атрибуты:
- Идентификатор операции (Transaction ID) — UUID
- Тип операции (Transaction Type) — Transfer / Deposit / Withdraw / Compensation
- Счёт-источник (From Account) — ссылка, опционально
- Счёт-получатель (To Account) — ссылка, опционально
- Сумма (Amount) — decimal / numeric, > 0
- Валюта (Currency) — ссылка
- Статус (Status) — Success / Rejected
- Код отказа (Rejection Code) — ссылка на справочник, опционально
- Автор операции (Initiator) — User
- Дата создания (Created At) — дата и время
- Дата завершения (Completed At) — дата и время

---

### 5.6. Проводка (Ledger Entry)

Тип: объектный, вспомогательный

Назначение: учётная запись изменения баланса конкретного счёта.

Атрибуты:
- Идентификатор проводки (Ledger Entry ID) — UUID
- Счёт (Account) — ссылка
- Сумма (Amount) — decimal / numeric со знаком
- Валюта (Currency) — ссылка
- Финансовая операция (Transaction) — ссылка
- Дата создания (Created At) — дата и время

---

### 5.7. Заявка (Request)

Тип: объектный

Назначение: запрос на действие, требующее одобрения оператора.

Типы заявок:
- Регистрация пользователя
- Пополнение счёта
- Снятие средств
- Перевод между счетами

Атрибуты:
- Идентификатор заявки (Request ID) — UUID
- Тип заявки (Request Type) — перечисление
- Пользователь (User) — инициатор
- Связанный счёт (Account) — опционально
- Сумма (Amount) — decimal / numeric, опционально
- Валюта (Currency) — ссылка, опционально
- Статус (Status) — Created / Pending Approval / Approved / Rejected
- Код причины (Reason Code) — ссылка на справочник, опционально
- Оператор (Operator) — пользователь, опционально
- Дата создания (Created At) — дата и время
- Дата решения (Decided At) — дата и время
- Связанная операция (Result Transaction ID) — UUID, созданная операция при Approved

---

### 5.8. Запись аудита (Audit Log)

Тип: объектный, вспомогательный

Назначение: фиксирование всех действий субъектов системы.

Атрибуты:
- Идентификатор записи (Audit Log ID) — UUID
- Тип субъекта (Actor Type) — User / Operator / Admin
- Идентификатор субъекта (Actor ID) — UUID
- Тип действия (Action Type) — строка
- Контекст (Context) — JSON / строка
- Дата и время (Timestamp) — дата и время

---

### 5.9. Настройки системы (System Settings)

Тип: справочный

Назначение: централизованное управление режимами работы VBank.

Атрибуты:
- Идентификатор (Id) — UUID, внутренний идентификатор.
- Ключ (Key) — строка, уникальный идентификатор настройки.
- Значение (Value) — строка, значение настройки.
- Тип значения (ValueType) — перечисление, String/Boolean/Number/Enum.
- Описание (Description) — строка, назначение настройки.
- Дата обновления (UpdatedAt) — дата-время, момент последнего изменения.

Минимальный набор настроек:
- Имя банка (BankName) — отображаемое название банка.
- Режим регистрации пользователей (RegistrationMode) — Auto/Manual.
- Режим внутренних переводов (InternalTransferMode) — Enabled/Disabled/Manual.
- Режим пополнения/вывода (CashInOutMode) — Manual/Disabled.
- Политика создания счетов (AccountOpeningMode) — Auto/Manual.

Ограничение (Settings Constraint): набор допустимых ключей и допустимые значения фиксируются в ТЗ; запись неизвестных ключей запрещена.

---

## 6. Связи между объектами

- Пользователь (User) владеет Счетами (Account)
- Счёт (Account) участвует в Финансовых операциях (Transaction)
- Финансовая операция (Transaction) порождает Проводки (Ledger Entry)
- Заявка (Request) при Approved создаёт Финансовую операцию (Transaction)
- Любое действие фиксируется Записью аудита (Audit Log)

---

## 7. Ограничения предметной области

- Сумма финансовой операции строго больше нуля.
- Валюта операции совпадает с валютой счёта.
- Переводы выполняются только между счетами одной валюты.
- Идемпотентность обязательна для всех изменяющих API-операций.
- Все ошибки отказа классифицируются фиксированным справочником кодов.
- Для операций списания (Transfer, Withdraw) баланс счёта после операции не может стать отрицательным, если у типа счёта не установлен флаг "Разрешён отрицательный баланс" (Allow Negative Balance).
- Для счетов с `Allow Negative Balance = true` отрицательный баланс допускается (лимит отрицательного баланса в предметной области не задан).

---
