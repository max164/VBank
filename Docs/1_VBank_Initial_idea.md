* 2026.01.22 20:07:01

# Первоначальная идея — Virtual Bank (VBank)

## 0. Паспорт документа

- Продукт: Virtual Bank (VB, VBank)
- Тип: виртуальная банковская система
- Назначение: учебный проект + переиспользуемый модуль "banking core"
- Платформа MVP: Backend (Java) + PostgreSQL + REST API `/api/v1/*` + CLI-клиент к API
- Выходные интерфейсы: REST API, CLI
- Версия документа: v0.2

---

## 1. Контекст и проблема

Cистема виртуальных счетов и операций, чтобы:
- хранить балансы участников,
- делать внутренние переводы,
- выполнять "пополнение/снятие" как виртуальные операции,
- иметь историю операций и аудит действий,
- разграничивать доступ ролями и обеспечивать контроль операций.

---

## 2. Цели

G1. Учебная: освоить практики разработки финансовых систем (учёт, транзакционность, аудит, безопасность).
G2. Модульность: получить переиспользуемое ядро банка с API для интеграции в другие системы.

Критерии успеха MVP:
- Любое изменение баланса фиксируется транзакцией и журналом операций.
- Баланс не уходит в минус (овердрафт запрещён).
- Операции имеют конечный статус: `SUCCESS` или `REJECTED` (либо `CANCELLED` пользователем/системой, если применимо).
- Возможность восстановить баланс на дату по журналу операций (ledger-подход).

---

## 3. Нецели

- Не "настоящий банк": нет реальных денег, платёжных шлюзов, эквайринга, KYC/AML.
- Нет кредитов, депозитов, карт в MVP.
- Нет Web/Desktop/Mobile UI в MVP (только CLI).
- Нет конвертации валют в MVP (только хранение/учёт по валютам).

---

## 4. Допущения и определения

- Виртуальные деньги: пополнение/снятие — внутренняя операция изменения баланса.
- Счёт: принадлежит пользователю и валюте.
- В MVP один счёт на одну валюту для пользователя.
- Перевод P2P: отправка по номеру счёта получателя.
- Комиссии и лимиты: в MVP не применяются, но модель данных должна предусматривать расширение.
- Заморозка средств: при переводе средства резервируются/замораживаются в рамках обработки операции, чтобы исключить гонки и двойные списания.

---

## 5. Пользователи и роли (RBAC)

- Client (Пользователь): свои счета, переводы, заявки, история.
- Operator (Оператор): подтверждение/отклонение заявок, контроль спорных операций, просмотр очереди.
- Admin (Администратор): пользователи, роли, справочники, настройки, аудит.

---

## 6. Основные сценарии (MVP)

S1. Регистрация и вход:
- регистрация пользователя,
- вход (получение токена/сессии),
- выход.

S2. Управление счетами:
- просмотр своих счетов (по валютам),
- открытие счёта в валюте (если ещё нет),
- закрытие счёта при `balance = 0`.

S3. Перевод по номеру счёта:
- пользователь вводит `from_account`, `to_account_number`, `amount`,
- система проверяет права, наличие средств, валидность счёта получателя,
- выполняет атомарную операцию с фиксацией в журнале.

S4. Пополнение/снятие через оператора:
- пользователь создаёт заявку (deposit/withdraw),
- оператор подтверждает или отклоняет с причиной,
- при подтверждении создаётся финансовая операция и изменяется баланс.

S5. История операций:
- пользователь видит список операций с фильтрами (период, тип, статус),
- детальная карточка операции.

S6. Администрирование:
- управление пользователями (статус, блокировка),
- назначение ролей,
- управление валютами (CRUD),
- настройки банка (название, логотип, режимы),
- просмотр аудита.

---

## 7. Объём и приоритеты

MVP (P0):
1. Регистрация/аутентификация, безопасное хранение паролей
2. RBAC: Client/Operator/Admin
3. Счета: 1 счёт на валюту, открыть/закрыть, баланс
4. Операции:
    - перевод по номеру счёта (P2P),
    - "пополнение/снятие" как заявки, подтверждаемые оператором
5. История операций и детализация
6. Справочник валют (CRUD Admin)
7. Аудит действий + серверные логи
8. REST API `/api/v1/*`
9. CLI-клиент (меню по ролям)
10. Настройки банка (продуктовые)

Post-MVP (P1/P2):
- Комиссии
- Лимиты/ограничения
- 2FA
- Уведомления
- Отчёты
- Аналитика расходов
- Web UI, Desktop (JavaFX), Mobile
- AI-агенты (автоматизация задач оператора)
- Банковские продукты (кредиты/депозиты/карты)

---

## 8. Функциональные требования (FR)

FR-1. Регистрация и аутентификация (P0):
- Регистрация уникального пользователя (логин/почта — решение реализации).
- Вход возвращает access-токен/сессию.
- Выход инвалидирует токен/сессию (в рамках выбранной модели).
- Пароли хэшируются устойчивым алгоритмом; хранение в открытом виде запрещено.

FR-2. Роли и доступ (P0):
- Система проверяет роль на каждом запросе.
- Client имеет доступ только к своим данным.
- Operator имеет доступ к очереди заявок и решениям.
- Admin управляет пользователями, ролями, справочниками, настройками, аудитом.

FR-3. Управление пользователями (P0):
- Admin:
    - назначает/снимает роли,
    - блокирует/разблокирует пользователей,
    - просматривает список пользователей и карточку.

FR-4. Счета (P0):
- Пользователь может иметь не более одного счёта на валюту.
- Открытие счёта:
    - валюта должна быть активна в справочнике,
    - повторное открытие для той же валюты запрещено.
- Закрытие счёта:
    - разрешено только если `balance = 0`,
    - закрытый счёт не участвует в операциях.

FR-5. Операции: общая модель (P0):
- Каждая операция имеет:
    - идентификатор,
    - тип,
    - сумму и валюту,
    - счета источника/получателя (если применимо),
    - статусы жизненного цикла,
    - автора операции,
    - (опционально) утверждающего оператора,
    - (опционально) причину отклонения,
    - временные метки.
- Операции должны поддерживать идемпотентность для защиты от повторной отправки запросов.

FR-6. Перевод по номеру счёта (P0):
- Вход: `from_account_id`, `to_account_number`, `amount`.
- Проверки:
    - счёт источника принадлежит инициатору,
    - счёт получателя существует и активен,
    - валюта совпадает (в MVP без конвертации),
    - достаточно средств.
- Исполнение:
    - атомарная транзакция БД,
    - заморозка/резервирование в рамках исполнения операции (конкурентная защита),
    - списание и зачисление фиксируются как записи в журнале.
- Выход: статус `SUCCESS` либо `REJECTED` с причиной.

FR-7. Пополнение/снятие (P0):
- Client создаёт заявку:
    - `DEPOSIT_REQUEST` / `WITHDRAW_REQUEST` (логически),
    - статус `PENDING_APPROVAL`.
- Operator:
    - видит очередь заявок,
    - подтверждает или отклоняет с причиной.
- При подтверждении:
    - создаётся финансовая операция `DEPOSIT` / `WITHDRAW`,
    - баланс меняется атомарно,
    - заявка получает итоговый статус.
- При отклонении:
    - баланс не меняется,
    - причина сохраняется.

FR-8. История операций (P0):
- Client видит только свои операции.
- Operator/Admin могут видеть операции в рамках полномочий (минимум: заявки и их решения).
- Фильтры: период, тип, статус.
- Пагинация обязательна.

FR-9. Справочник валют (P0):
- Admin CRUD:
    - код (например ISO-подобный), название, символ, precision, enabled.
- Запрет удаления валюты, если она используется счетами (решение: disable вместо delete).

FR-10. Настройки банка (P0):
- Продуктовые настройки (Admin):
    - название,
    - логотип (как метаданные),
    - режимы (например: требовать ли подтверждения оператора для deposit/withdraw — в MVP включено).
- Инфраструктурные настройки (БД, host/port) — вне PRD, задаются конфигурацией деплоя.

FR-11. Аудит действий (P0):
- Записывать действия:
    - вход/выход,
    - создание/закрытие счёта,
    - создание операции/заявки,
    - решение оператора,
    - изменения справочников и ролей.
- Аудит должен быть неизменяемым (append-only логически).

---

## 9. Нефункциональные требования (NFR)

NFR-1. Безопасность (P0):
- TLS для client-server.
- Хэширование паролей с солью.
- Ограничение перебора паролей (rate limit/lockout базового уровня).
- Секреты (БД, ключи) — только через конфиг/секрет-хранилище, не в коде.

NFR-2. Консистентность и транзакционность (P0):
- Денежные операции атомарны.
- Конкурентная защита от двойного списания (`lock/optimistic versioning/serializable` — решение реализации).
- Идемпотентность для внешних вызовов.

NFR-3. Наблюдаемость (P0):
- `request_id`/`correlation_id` в логах.
- Структурированные логи.
- Ошибки возвращаются единообразно.

NFR-4. Производительность (ориентир P0):
- Операции перевода: выполнение в пределах секунд на локальной БД.
- История операций: постраничная выдача.

---

## 10. Данные и расширяемость (концептуально)

Базовые сущности (P0):
- `User`
- `Account` (включая `account_number` как публичный идентификатор для переводов)
- `Currency`
- `Transaction` (финансовые операции)
- `Request/Approval` (для operator-подтверждений) — отдельная сущность или часть модели операций (решение реализации)
- `AuditLog`

Расширения "на будущее" (заложить места в модели):
- Комиссии (P1):
    - поля уровня операции: `fee_amount`, `fee_currency`, `fee_policy_id` или `fee_details`,
    - возможность проводить комиссию как отдельную проводку (ledger line) или отдельную transaction.
- Лимиты (P1):
    - сущность `LimitPolicy` (по роли/пользователю/счёту),
    - поля для контроля дневных/месячных лимитов по сумме и количеству операций,
    - журнал превышений/отказов.

---

## 11. CLI (MVP)

CLI — клиент к REST API. Функции:
- авторизация,
- определение роли и меню.

Client меню:
- счета (просмотр/открыть/закрыть),
- перевод по номеру счёта,
- заявки пополнить/снять,
- история операций.

Operator меню:
- список заявок pending,
- детали заявки,
- approve/reject (с причиной).

Admin меню:
- пользователи/роли,
- валюты,
- настройки банка,
- просмотр аудита.

---

## 12. Приёмочные критерии MVP

- Регистрация/логин/логаут работают; пароль в БД не хранится в открытом виде.
- Пользователь может открыть счёт в валюте, второй счёт той же валюты создать нельзя.
- Перевод по номеру счёта выполняется атомарно: либо полностью успешен, либо отклонён без частичных изменений.
- Deposit/Withdraw проходят через оператора; без approve баланс не меняется.
- История операций отражает все действия с правильными статусами.
- Аудит фиксирует ключевые действия и доступен Admin.

---

## 13. Риски

- Ошибки конкуренции при переводах (гонки) → обязательна транзакционная модель и идемпотентность.
- Разрастание объёма за счёт UI и "реального банкинга" → зафиксированы нецели.
- Ошибки проектирования данных под будущие комиссии/лимиты → заложены точки расширения в модели.

---
