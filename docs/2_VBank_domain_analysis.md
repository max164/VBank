* 2026.02.01 22:04:03

# Анализ предметной области системы виртуального банка VBank

---

## 1. Назначение и границы предметной области

VBank — виртуальная банковская система, предназначенная для:
- ведения счетов пользователей в нескольких валютах;
- выполнения финансовых операций между счетами;
- обработки заявок на пополнение и снятие средств;
- обеспечения аудита и воспроизводимости финансового состояния.

Система не является платёжной системой, не взаимодействует с внешними банками и не выполняет реальных финансовых расчётов. Все операции существуют исключительно внутри домена VBank.

---

## 2. Ключевые принципы предметной области

1. Баланс счёта хранится явно и используется как рабочее значение.
2. Журнал проводок (ledger) является вторичным источником для:
   - аудита;
   - сверки;
   - восстановления состояния при ошибках.
3. Любая финансовая операция необратима:
   - отмена запрещена;
   - компенсация выполняется новой операцией.
4. Все операции атомарны и транзакционны.
5. Отрицательный баланс разрешен для некоторых типов счетов.
6. Конкурентный доступ регулируется транзакционной блокировкой БД.
7. Деньги существуют только в рамках счёта и валюты.

---

## 3. Участники предметной области (роли)

### 3.1. Пользователь (Client)
Лицо, владеющее счетами и инициирующее операции.

### 3.2. Оператор (Operator)
Сотрудник системы, обрабатывающий заявки на пополнение и снятие средств, имеющий доступ к персональным данным и полной истории операций.

### 3.3. Администратор (Admin)
Системная роль для управления пользователями, ролями и справочниками.

---

## 4. Ключевые объекты предметной области

### 4.1. Пользователь
Тип: объектный  
Назначение: субъект владения счетами и инициатор операций.

Атрибуты:
- Идентификатор пользователя
- Email
- Номер телефона
- Роль
- Статус (активен / заблокирован)
- Дата регистрации

---

### 4.2. Счёт
Тип: объектный  
Назначение: хранение денежных средств в одной валюте.

Инварианты:
- Один пользователь — один счёт на валюту.

Атрибуты:
- Номер счёта (20 цифр, структурированный)
- Пользователь
- Валюта
- Тип счёта
- Тип продукта
- Баланс
- Статус (активен / заблокирован)

---

### 4.3. Валюта
Тип: справочный, обобщающий  
Назначение: описание денежных единиц.

Атрибуты:
- Код валюты (RUB, USD, EUR)
- Precision (2–10 знаков)
- Статус (активна / отключена)

---

### 4.4. Финансовая операция
Тип: объектный, ключевой  
Назначение: фиксирует факт изменения баланса счёта.

Принципы:
- Может быть отклонена до изменения баланса.
- При необходимости отмены создаётся компенсирующая операция.

Атрибуты:
- Идентификатор операции
- Тип операции (перевод, пополнение, снятие, компенсация)
- Счёт-источник
- Счёт-получатель
- Сумма
- Валюта
- Статус (SUCCESS / REJECTED)
- Код отказа (при REJECTED)
- Дата создания
- Дата завершения

---

### 4.5. Проводка (Ledger Entry)
Тип: объектный, вспомогательный  
Назначение: детализированная запись изменения баланса.

Принципы:
- Используется для аудита и сверки.
- Связана с одной финансовой операцией.

Атрибуты:
- Идентификатор проводки
- Счёт
- Сумма (со знаком)
- Валюта
- Ссылка на финансовую операцию
- Дата создания

---

### 4.6. Заявка
Тип: объектный  
Назначение: запрос пользователя на действие, требующее одобрения оператора.

Принципы:
- Не изменяет баланс.
- После одобрения порождает финансовую операцию.

Атрибуты:
- Идентификатор заявки
- Тип заявки (пополнение / снятие)
- Пользователь
- Счёт
- Сумма
- Валюта
- Статус (CREATED / PENDING_APPROVAL / APPROVED / REJECTED)
- Код отказа (при REJECTED)
- Даты создания и обработки

---

### 4.7. Запись аудита
Тип: объектный, вспомогательный  
Назначение: фиксирование действий пользователей, операторов и администраторов.

Принципы:
- Только добавление (append-only).
- Не изменяется и не удаляется.

Атрибуты:
- Идентификатор записи
- Тип субъекта (пользователь / оператор / администратор)
- Идентификатор субъекта
- Тип действия
- Контекст действия
- Дата и время

---

## 5. Функциональные области системы

### 5.1. Управление пользователями
- Регистрация
- Аутентификация
- Блокировка / разблокировка
- Назначение ролей

### 5.2. Управление счетами
- Создание счёта
- Просмотр баланса и реквизитов
- Блокировка счёта

### 5.3. Финансовые операции
- Перевод между счетами
- Пополнение через заявку
- Снятие через заявку
- Компенсационные операции

### 5.4. Обработка заявок
- Просмотр очереди
- Одобрение / отклонение
- Формирование операций

### 5.5. Аудит и история
- История операций
- Журнал действий
- Сверка баланса и ledger

---

## 6. Связи между объектами (укрупнённо)

- Пользователь → владеет → Счёт
- Счёт → участвует → Финансовая операция
- Финансовая операция → порождает → Проводка
- Заявка → при APPROVED → создаёт → Финансовую операцию
- Любое действие → фиксируется → Записью аудита

---

## 7. Ограничения предметной области

- Сумма операции строго больше нуля.
- Валюта операции совпадает с валютой счёта.
- Переводы возможны только между счетами одной валюты.
- Все ошибки отказа классифицируются фиксированным справочником кодов.
- Идемпотентность обязательна для всех изменяющих операций.

---
